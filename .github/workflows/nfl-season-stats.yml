name: NFL Season Stats Only

on:
  # Run manually via GitHub Actions UI
  workflow_dispatch:
    inputs:
      seasons:
        description: 'Year range (e.g., "2022:2025")'
        required: false
        default: '2025'
        type: string
      season_type:
        description: 'Season type'
        required: false
        default: 'REG'
        type: choice
        options:
          - 'REG'
          - 'POST'
          - 'REG+POST'
  
  # Run on schedule (optional - uncomment if you want automatic runs)
  # schedule:
  #   - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

jobs:
  fetch-season-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3'
    
    - name: Install R dependencies
      run: |
        # Install system dependencies first
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev
        
        # Install R packages with error handling
        Rscript -e "
        options(repos = c(CRAN = 'https://cran.rstudio.com/'))
        
        # Install dplyr first (dependency)
        if (!require(dplyr, quietly = TRUE)) {
          cat('Installing dplyr...\n')
          install.packages('dplyr', repos = 'https://cran.rstudio.com/')
        }
        
        # Install nflfastR
        if (!require(nflfastR, quietly = TRUE)) {
          cat('Installing nflfastR...\n')
          install.packages('nflfastR', repos = 'https://cran.rstudio.com/')
        }
        
        # Verify installation
        cat('Verifying package installation...\n')
        if (require(nflfastR, quietly = TRUE)) {
          cat('✓ nflfastR installed successfully\n')
        } else {
          cat('❌ nflfastR installation failed\n')
          quit(status = 1)
        }
        
        if (require(dplyr, quietly = TRUE)) {
          cat('✓ dplyr installed successfully\n')
        } else {
          cat('❌ dplyr installation failed\n')
          quit(status = 1)
        }
        "
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Node.js dependencies
      run: npm install
    
    - name: Fetch NFL season statistics
      run: |
        # Set parameters if provided
        if [ -n "${{ github.event.inputs.seasons }}" ]; then
          echo "SEASONS=${{ github.event.inputs.seasons }}" >> $GITHUB_ENV
        fi
        if [ -n "${{ github.event.inputs.season_type }}" ]; then
          echo "SEASON_TYPE=${{ github.event.inputs.season_type }}" >> $GITHUB_ENV
        fi
        
        # Verify packages are available before running script
        Rscript -e "
        if (!require(nflfastR, quietly = TRUE)) {
          cat('❌ nflfastR not available\n')
          quit(status = 1)
        }
        if (!require(dplyr, quietly = TRUE)) {
          cat('❌ dplyr not available\n')
          quit(status = 1)
        }
        cat('✓ All packages verified\n')
        "
        
        Rscript fetch_season_data.R
      env:
        SEASONS: ${{ github.event.inputs.seasons || '2020:2024' }}
        SEASON_TYPE: ${{ github.event.inputs.season_type || 'REG' }}
        FETCH_WEEKLY: 'FALSE'  # Always FALSE for this workflow
    
    - name: Upload to MongoDB
      run: |
        npm run upload_data season
      env:
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        MONGODB_DATABASE: ${{ secrets.MONGODB_DATABASE }}
    

    - name: Upload CSV files as artifacts (if small enough)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nfl-season-stats-csv
        path: data_output/season_stats/
        retention-days: 7

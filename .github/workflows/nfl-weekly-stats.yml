name: NFL Weekly Stats (Large Dataset)

on:
  # Run manually via GitHub Actions UI
  workflow_dispatch:
    inputs:
      seasons:
        description: 'Year range (e.g., "2020:2024") - WARNING: Large datasets!'
        required: false
        default: '2020:2024'
        type: string
      season_type:
        description: 'Season type'
        required: false
        default: 'REG'
        type: choice
        options:
          - 'REG'
          - 'POST'
          - 'REG+POST'
      confirm_large_dataset:
        description: 'Confirm you understand this creates large files (5GB+)'
        required: true
        default: false
        type: boolean

jobs:
  fetch-weekly-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Validate large dataset confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_large_dataset }}" != "true" ]; then
          echo "‚ùå You must confirm that you understand this creates large files"
          echo "‚ö†Ô∏è  Weekly stats can be 5GB+ and may timeout on GitHub Actions"
          exit 1
        fi
        echo "‚úÖ Large dataset confirmation received"
    
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3'
    
    - name: Install R dependencies
      run: |
        # Install system dependencies first
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev
        
        # Install R packages with error handling
        Rscript -e "
        options(repos = c(CRAN = 'https://cran.rstudio.com/'))
        
        # Install dplyr first (dependency)
        if (!require(dplyr, quietly = TRUE)) {
          cat('Installing dplyr...\n')
          install.packages('dplyr', repos = 'https://cran.rstudio.com/')
        }
        
        # Install nflfastR
        if (!require(nflfastR, quietly = TRUE)) {
          cat('Installing nflfastR...\n')
          install.packages('nflfastR', repos = 'https://cran.rstudio.com/')
        }
        
        # Verify installation
        cat('Verifying package installation...\n')
        if (require(nflfastR, quietly = TRUE)) {
          cat('‚úì nflfastR installed successfully\n')
        } else {
          cat('‚ùå nflfastR installation failed\n')
          quit(status = 1)
        }
        
        if (require(dplyr, quietly = TRUE)) {
          cat('‚úì dplyr installed successfully\n')
        } else {
          cat('‚ùå dplyr installation failed\n')
          quit(status = 1)
        }
        "
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Node.js dependencies
      run: npm install
    
    - name: Create output directory
      run: mkdir -p nfl_data_output
    
    - name: Fetch NFL weekly statistics
      run: |
        # Set parameters if provided
        if [ -n "${{ github.event.inputs.seasons }}" ]; then
          echo "SEASONS=${{ github.event.inputs.seasons }}" >> $GITHUB_ENV
        fi
        if [ -n "${{ github.event.inputs.season_type }}" ]; then
          echo "SEASON_TYPE=${{ github.event.inputs.season_type }}" >> $GITHUB_ENV
        fi
        
        # Verify packages are available before running script
        Rscript -e "
        if (!require(nflfastR, quietly = TRUE)) {
          cat('‚ùå nflfastR not available\n')
          quit(status = 1)
        }
        if (!require(dplyr, quietly = TRUE)) {
          cat('‚ùå dplyr not available\n')
          quit(status = 1)
        }
        cat('‚úì All packages verified\n')
        "
        
        echo "‚ö†Ô∏è  Starting weekly stats fetch - this may take 30-60 minutes"
        echo "üìä Fetching seasons: ${{ github.event.inputs.seasons || '2020:2024' }}"
        echo "üìà This will create large CSV files (5GB+)"
        
        Rscript fetch_weekly_data.R
      env:
        SEASONS: ${{ github.event.inputs.seasons || '2020:2024' }}
        SEASON_TYPE: ${{ github.event.inputs.season_type || 'REG' }}
        FETCH_WEEKLY: 'TRUE'  # Always TRUE for this workflow
    
    - name: Upload to Firebase
      run: node upload_player_stats_to_firebase.js
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
    
    - name: Upload logs as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: weekly-stats-logs
        path: |
          nfl_player_stats_log.txt
          upload_errors.json
          upload_checkpoint.json
        retention-days: 30
    
    - name: Upload CSV files as artifacts (compressed)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nfl-weekly-stats-csvs
        path: nfl_data_output/
        retention-days: 3  # Shorter retention due to size

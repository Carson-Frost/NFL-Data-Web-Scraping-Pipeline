name: NFL Weekly Update

on:
  # Manual triggers only (schedule will be added later)
  workflow_dispatch:
    inputs:
      season:
        description: 'Season year (e.g., 2024)'
        required: false
        default: '2024'
        type: string
      season_type:
        description: 'Season type'
        required: false
        default: 'REG'
        type: choice
        options:
          - 'REG'
          - 'POST'
          - 'REG+POST'

jobs:
  weekly-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3'
    
    - name: Install R dependencies
      run: |
        # Install system dependencies first
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev
        
        # Install R packages with error handling
        Rscript -e "
        options(repos = c(CRAN = 'https://cran.rstudio.com/'))
        
        # Install dplyr first (dependency)
        if (!require(dplyr, quietly = TRUE)) {
          cat('Installing dplyr...\n')
          install.packages('dplyr', repos = 'https://cran.rstudio.com/')
        }
        
        # Install nflfastR
        if (!require(nflfastR, quietly = TRUE)) {
          cat('Installing nflfastR...\n')
          install.packages('nflfastR', repos = 'https://cran.rstudio.com/')
        }
        
        # Verify installation
        cat('Verifying package installation...\n')
        if (require(nflfastR, quietly = TRUE)) {
          cat('‚úì nflfastR installed successfully\n')
        } else {
          cat('‚ùå nflfastR installation failed\n')
          quit(status = 1)
        }
        
        if (require(dplyr, quietly = TRUE)) {
          cat('‚úì dplyr installed successfully\n')
        } else {
          cat('‚ùå dplyr installation failed\n')
          quit(status = 1)
        }
        "
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Node.js dependencies
      run: npm install
    
    - name: Create output directory
      run: mkdir -p nfl_data_output
    
    - name: Fetch current season stats (season + weekly)
      run: |
        # Use current season or input
        CURRENT_SEASON=${{ github.event.inputs.season || '2024' }}
        SEASON_TYPE_INPUT=${{ github.event.inputs.season_type || 'REG' }}
        echo "SEASONS=$CURRENT_SEASON" >> $GITHUB_ENV
        echo "SEASON_TYPE=$SEASON_TYPE_INPUT" >> $GITHUB_ENV
        echo "FETCH_WEEKLY=TRUE" >> $GITHUB_ENV
        
        # Verify packages are available before running script
        Rscript -e "
        if (!require(nflfastR, quietly = TRUE)) {
          cat('‚ùå nflfastR not available\n')
          quit(status = 1)
        }
        if (!require(dplyr, quietly = TRUE)) {
          cat('‚ùå dplyr not available\n')
          quit(status = 1)
        }
        cat('‚úì All packages verified\n')
        "
        
        echo "üìä Fetching season $CURRENT_SEASON stats (season + weekly data)"
        echo "‚ö†Ô∏è  This includes weekly data for comprehensive analysis"
        
        Rscript nfl_player_stats_fetch.R
      env:
        SEASONS: ${{ github.event.inputs.season || '2024' }}
        SEASON_TYPE: ${{ github.event.inputs.season_type || 'REG' }}
        FETCH_WEEKLY: 'TRUE'
    
    - name: Upload to Firebase
      run: node upload_player_stats_to_firebase.js
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
    
    - name: Upload logs as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: weekly-update-logs
        path: |
          nfl_player_stats_log.txt
          upload_errors.json
          upload_checkpoint.json
        retention-days: 30
    
    - name: Upload CSV files as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nfl-weekly-update-csvs
        path: nfl_data_output/
        retention-days: 7
